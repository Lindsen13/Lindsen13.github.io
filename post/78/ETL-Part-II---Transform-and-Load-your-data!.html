<!DOCTYPE html>
<html lang="en">
 

<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-149203155-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-149203155-2');
    </script>
    <!-- Favicons -->

    <link href="/static/img/favicon/android-chrome-512x512.png" rel="icon">
    <link href="/static/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="/static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/vendor/markdown-converter/styles.css" rel="stylesheet">

    <link href="/static/vendor/icofont/icofont.min.css" rel="stylesheet">
    <link href="/static/vendor/aos/aos.css" rel="stylesheet">
    <link href="/static/vendor/line-awesome/css/line-awesome.min.css" rel="stylesheet">
    <link href="/static/vendor/owl.carousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link href="/static/css/style.css" rel="stylesheet">

    <meta name="robots" content="index, follow">

    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport"> 
<title>Python Everything - ETL Part II - Transform and Load your data!</title>
<meta name="description" content="Developing an ETL system, where we fetch data, transform and enrich, and prepare for visualisation! - Last time, we wrote ETL Part I. This time, we will continue where we..."> 
</head>

<body>

    <!-- ======= Mobile Menu ======= -->
    <div class="site-mobile-menu site-navbar-target">
        <div class="site-mobile-menu-header">
            <div class="site-mobile-menu-close mt-3">
                <span class="icofont-close js-menu-toggle"></span>
            </div>
        </div>
        <div class="site-mobile-menu-body"></div>
    </div>

    <!-- ======= Header ======= -->
    <header class="site-navbar js-sticky-header site-navbar-target" role="banner">

        <div class="container">
            <div class="row align-items-center">

                <div class="col-6 col-lg-2">
                    <h1 class="mb-0 site-logo"><a href="/" class="mb-0">Python Everything</a></h1>
                </div>

                <div class="col-12 col-md-10 d-none d-lg-block">
                    <nav class="site-navigation position-relative text-right" role="navigation">

                        <ul class="site-menu main-menu js-clone-nav mr-auto d-none d-lg-block">
                            <li class="active"><a href="/" class="nav-link">Home</a></li>
                            <li><a href="/explore/1.html" class="nav-link">Explore</a></li>
                            <li><a href="/authors.html" class="nav-link">Collaborators</a></li>
                            <li><a href="/#contact" class="nav-link">Get in touch</a></li>
                        </ul>
                    </nav>
                </div>

                <div class="col-6 d-inline-block d-lg-none ml-md-0 py-3" style="position: relative; top: 3px;">

                    <a href="#" class="burger site-menu-toggle js-menu-toggle" data-toggle="collapse" data-target="#main-navbar">
                        <span></span>
                    </a>
                </div>

            </div>
        </div>

    </header>

    

<main id="main">

    <section class="hero-section inner-page">
        <div class="wave">

            <svg width="1920px" height="265px" viewBox="0 0 1920 265" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g id="Apple-TV" transform="translate(0.000000, -402.000000)" fill="#FFFFFF">
              <path d="M0,439.134243 C175.04074,464.89273 327.944386,477.771974 458.710937,477.771974 C654.860765,477.771974 870.645295,442.632362 1205.9828,410.192501 C1429.54114,388.565926 1667.54687,411.092417 1920,477.771974 L1920,667 L1017.15166,667 L0,667 L0,439.134243 Z" id="Path"></path>
            </g>
          </g>
        </svg>

        </div>

        <div class="container">
            <div class="row align-items-center">
                <div class="col-12">
                    <div class="row justify-content-center">
                        <div class="col-md-10 text-center hero-text">
                            <h1 data-aos="fade-up" data-aos-delay=""><h1>ETL Part II - Transform and Load your data!</h1></h1>
                            <p class="mb-5" data-aos="fade-up" data-aos-delay="100">2020-07-25 &bullet; By <a href="#" class="text-white">Ivo</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </section>

    <section class="site-section mb-4">
        <div class="container">
            <div class="row">
                <div class="col-md-8 blog-content">

                    <p class="lead mb-5"><p>Developing an <strong>ETL</strong> system, where we <strong>fetch</strong> data, transform and enrich, and prepare for <strong>visualisation</strong>!</p></p>
                    <p><p>Last time, we wrote <em>ETL Part I</em>. This time, we will continue where we left: <em>ETL Part II</em>!</p>
<p>ETL stands for Extract, Transform and Load. The first part explained how make an API call, process it and store it in a database for future use (which is the <em>Extract</em> part of <em>ETL</em>). This part will focus on <em>Transform</em> and <em>Load</em>. We will use the extracted exchange-rate data to transform a sample data set with sales numbers.</p>
<p>You can download the sample dataset <a href="https://python-everything.com/static/blogpost_content/sample_sales.csv">here</a></p>
<p>As you can see, we have sales numbers in different currencies. We want to convert all the currencies into USD values, so we can make any future analysis without having to think about different currencies.</p>
<p>Lets initiate a directory with all the files we need:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># create a directory called &#39;etl_part_2&#39;</span>
mkdir etl_part_1
<span class="c1"># Navigate into the directory</span>
<span class="nb">cd</span> etl_part_2
<span class="c1"># Create a virtual environment</span>
python3 -m venv env
<span class="c1"># Activate the virtual environment</span>
<span class="nb">source</span> env/bin/activate
<span class="c1"># Install the &#39;pandas&#39; package.</span>
pip install pandas
<span class="c1"># Install the &#39;PyMySQL&#39; package.</span>
pip install pymysql
<span class="c1"># Install the &#39;SQLAlchemy&#39; package.</span>
pip install sqlalchemy
<span class="c1"># Create a python file for the script</span>
touch script.py
<span class="c1"># Create a python file for the configuration info</span>
touch config.py
<span class="c1"># Create a python file for the SQL tables</span>
touch models.py
</code></pre></div>


<p>We will try to use the same layout as in <a href="https://python-everything.com/post/77/ETL-Part-I---From-API-to-stored-in-a-database.html">ETL Part I</a>. If you haven't read that one, I'd highly recommend to do so before continue reading this post.</p>
<p>Let's start with the <em>config.py</em> file. We will only need the <em>db-dictionary</em> from last time:</p>
<div class="codehilite"><pre><span></span><code><span class="n">db</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;url_to_database&quot;</span><span class="p">,</span>
    <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;username_for_database&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;password_for_database&quot;</span><span class="p">,</span>
    <span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="s2">&quot;database_name&quot;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>


<p>Furthermore, we will create a SQL table again, exactly in the same way as we did last time. Only difference will be the table names, column names and column data types.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.pool</span> <span class="kn">import</span> <span class="n">NullPool</span>

<span class="k">def</span> <span class="nf">db_connect</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">db_url</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">poolclass</span><span class="o">=</span><span class="n">NullPool</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create_db_session</span><span class="p">(</span><span class="n">engine</span><span class="p">):</span>
    <span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">autoflush</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">session</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span>

<span class="k">class</span> <span class="nc">Sales</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A table with processed Sales numbers</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;Sales&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
    <span class="n">orderdate</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sales</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">currency</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">customer_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">country</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">db_connect</span><span class="p">()</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">create_db_session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
</code></pre></div>


<p>This will result in a SQL table with eight columns: id, created_at, orderdate, sales, currency, product, customer_name and country. </p>
<p>For our <em>script.py</em> file we can re-use some imports and functions from last time.</p>
<p>::python
    from config import *
    import pymysql.cursors
    import pymysql</p>
<div class="codehilite"><pre><span></span><code><span class="err">def create_connection():</span>
<span class="err">    return pymysql.connect(host=db.get(&quot;host&quot;),</span>
<span class="err">                        user=db.get(&quot;username&quot;),</span>
<span class="err">                        password=db.get(&quot;password&quot;),</span>
<span class="err">                        db=db.get(&quot;db&quot;),</span>
<span class="err">                        charset=&#39;utf8mb4&#39;,</span>
<span class="err">                        cursorclass=pymysql.cursors.DictCursor)</span>
</code></pre></div>


<p>On top of this, we will need to define four functions:
- A function that retrieves all the sales data from our sample file
- A function that retrieves all the exchange rates data from our SQL server
- A function that combines the two
- A function that stores the data in our new 'Sales' table on our SQL server</p>
<p>Let's start with the first function, which allows us to read in all the sales data from our example file.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="k">def</span> <span class="nf">read_sales</span><span class="p">():</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT date, currency, MIN(value) as value FROM ExchangeRates GROUP BY date, currency&quot;</span>
    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">df_exchange_rates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">df_exchange_rates</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_exchange_rates</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_exchange_rates</span>
</code></pre></div>


<p>We import <a href="https://pandas.pydata.org/">Pandas</a>, one of the more better-known python libraries for data handling.</p>
<p>Our <em>read_sales()</em> function creates a connection to the database, executes a SQL query, fetches the data and transforms it to a Pandas dataframe. We convert the <em>date</em> column into a datetime object, since we will use this column for joining. Note our SQL query:</p>
<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span> <span class="nb">date</span><span class="p">,</span> <span class="n">currency</span><span class="p">,</span> <span class="k">MIN</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">as</span> <span class="n">value</span> <span class="k">FROM</span> <span class="n">ExchangeRates</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="nb">date</span><span class="p">,</span> <span class="n">currency</span><span class="p">;</span>
</code></pre></div>


<p>We are grouping by <em>date</em> and <em>currency</em>, and taking the minimum <em>value</em>. The reason to do so, is to ensure we only retrieve one value per date, currency combination.</p>
<table>
<thead>
<tr>
<th></th>
<th>date</th>
<th>currency</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2019-01-01</td>
<td>AED</td>
<td>4.20995</td>
</tr>
<tr>
<td>1</td>
<td>2019-01-01</td>
<td>AFN</td>
<td>86.66430</td>
</tr>
<tr>
<td>2</td>
<td>2019-01-01</td>
<td>ALL</td>
<td>123.87300</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>2</td>
<td>2020-07-24</td>
<td>ZMK</td>
<td>10452.60000</td>
</tr>
<tr>
<td>2</td>
<td>2020-07-24</td>
<td>ZMW</td>
<td>21.03410</td>
</tr>
<tr>
<td>2</td>
<td>2020-07-24</td>
<td>ZWL</td>
<td>373.92100</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>Next up we need to read in the <em>csv</em> file with our sample sales:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">read_exchange_rates</span><span class="p">():</span>
    <span class="n">df_sample_sales</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;sample_sales.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">df_sample_sales</span><span class="o">.</span><span class="n">ORDERDATE</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_sample_sales</span><span class="o">.</span><span class="n">ORDERDATE</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_sample_sales</span>
</code></pre></div>


<p>for the <em>read_exchange_rates()</em> function, we are using Pandas' .read_csv() function. We use the optional arguments to specify the seperator and the decimal point. Converting the date column to datetime is done here as well, to ensure a proper joining. This will be done in the <em>convert_sales()</em> function.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">convert_sales</span><span class="p">(</span><span class="n">df_exchange_rates</span><span class="p">,</span> <span class="n">df_sample_sales</span><span class="p">):</span>
    <span class="n">df_output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">df_sample_sales</span><span class="p">,</span> 
        <span class="n">right</span> <span class="o">=</span> <span class="n">df_exchange_rates</span><span class="p">,</span> 
        <span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ORDERDATE&#39;</span><span class="p">,</span><span class="s1">&#39;CURRENCY&#39;</span><span class="p">],</span> 
        <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;currency&#39;</span><span class="p">],</span> 
        <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">df_output</span><span class="o">.</span><span class="n">SALES</span> <span class="o">=</span> <span class="n">df_output</span><span class="o">.</span><span class="n">SALES</span> <span class="o">/</span> <span class="n">df_output</span><span class="o">.</span><span class="n">value</span>
    <span class="n">df_output</span> <span class="o">=</span> <span class="n">df_output</span><span class="p">[[</span><span class="s1">&#39;ORDERDATE&#39;</span><span class="p">,</span><span class="s1">&#39;SALES&#39;</span><span class="p">,</span><span class="s1">&#39;PRODUCT&#39;</span><span class="p">,</span><span class="s1">&#39;CUSTOMERNAME&#39;</span><span class="p">,</span><span class="s1">&#39;COUNTRY&#39;</span><span class="p">]]</span>
    <span class="n">df_output</span><span class="p">[</span><span class="s1">&#39;CURRENCY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span>
    <span class="k">return</span> <span class="n">df_output</span>
</code></pre></div>


<p>The <em>convert_sales()</em> function should explain why we convert the data sets into Pandas' dataframes: to leverage the <em>.merge()</em> function. We do a <a href="https://stackoverflow.com/questions/38549/what-is-the-difference-between-inner-join-and-outer-join/38578">left join</a> on the <em>date</em> and the <em>currency</em> columns (called <em>ORDERDATE</em> and <em>CURRENCY</em> for our sample sales dataset respectively, and <em>date</em> and <em>currency</em> for our exhange rates dataset). The "real" transformation is done in just one line of code:</p>
<div class="codehilite"><pre><span></span><code><span class="n">df_output</span><span class="o">.</span><span class="n">SALES</span> <span class="o">=</span> <span class="n">df_output</span><span class="o">.</span><span class="n">SALES</span> <span class="o">/</span> <span class="n">df_output</span><span class="o">.</span><span class="n">value</span>
</code></pre></div>


<p>Where we convert the sales values into USD sales values. After renaming and selecting only relevant columns, we are left with the following dataset:</p>
<table>
<thead>
<tr>
<th></th>
<th>ORDERDATE</th>
<th>SALES</th>
<th>PRODUCT</th>
<th>CUSTOMERNAME</th>
<th>COUNTRY</th>
<th>CURRENCY</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>2019-08-03</td>
<td>2398.810471</td>
<td>Product A</td>
<td>Customer 1</td>
<td>Denmark</td>
<td>USD</td>
</tr>
<tr>
<td>1</td>
<td>2019-10-11</td>
<td>2565.058058</td>
<td>Product A</td>
<td>Customer 2</td>
<td>Canada</td>
<td>USD</td>
</tr>
<tr>
<td>2</td>
<td>2019-02-20</td>
<td>3456.338526</td>
<td>Product A</td>
<td>Customer 3</td>
<td>Australia</td>
<td>USD</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>2800</td>
<td>2019-06-13</td>
<td>4802.767706</td>
<td>Product F</td>
<td>Customer 24</td>
<td>United States</td>
<td>USD</td>
</tr>
<tr>
<td>2801</td>
<td>2019-12-02</td>
<td>1864.159849</td>
<td>Product F</td>
<td>Customer 52</td>
<td>Japan</td>
<td>USD</td>
</tr>
<tr>
<td>2802</td>
<td>2019-09-09</td>
<td>2600.439589</td>
<td>Product F</td>
<td>Customer 59</td>
<td>Switzerland</td>
<td>USD</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>The last thing we have to do, is to insert this into our newly made SQL table, called <em>Sales</em>. </p>
<p><img alt="Personal view on ETL Process" src="https://python-everything.com/static/blogpost_content/custom_interpretation_etl_process.png" /></p>
<p>Visually, we are at the second <code>&lt;/&gt;</code> tag, where we prepare our data for the <em>staging</em> database:</p>
<div class="codehilite"><pre><span></span><code><span class="err">database</span>
<span class="err">├── input</span>
<span class="err">│   ├── ExchangeRates</span>
<span class="err">│   ├── Customers</span>
<span class="err">│   ├── Dates</span>
<span class="err">│   ├── Sales</span>
<span class="err">│   └── Orders</span>
<span class="err">├── staging</span>
<span class="err">│   ├── Sales</span>
<span class="err">│   └── Orders</span>
<span class="err">└── output</span>
<span class="err">    ├── ProfitAnalysis</span>
<span class="err">    └── ChurnAnalysis</span>
</code></pre></div>


<p>We would like to make sure the table is empty before we insert this data, to ensure we are not generating any duplicate sales. This is done with a <em>DELETE</em> statement.</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">store_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;DELETE FROM Sales&#39;</span>
    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;(&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ORDERDATE&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;,</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SALES&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">,&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CURRENCY&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;,&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PRODUCT&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;,&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CUSTOMERNAME&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;,&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COUNTRY&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;),&#39;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;INSERT INTO Sales (orderdate, sales, currency, product, customer_name, country) VALUES </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>


<p>Note that we use a similar logic as in <a href="https://python-everything.com/post/77/ETL-Part-I---From-API-to-stored-in-a-database.html">previous blog post</a>. We loop over the data we would like to store, and for each row we create the following string:</p>
<div class="codehilite"><pre><span></span><code><span class="err">&quot;(value_1, value2, value3, ..., valuen),&quot;</span>
</code></pre></div>


<p>Which we combine with an <em>INSERT</em> statement afterwards. </p>
<p>Combining all the above together, and including a logic to ensure we only execute the functions when we call the file itself, results into the completed <em>script.py</em> file:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">pymysql.cursors</span>
<span class="kn">import</span> <span class="nn">pymysql</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="k">def</span> <span class="nf">create_connection</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">),</span>
                        <span class="n">user</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">),</span>
                        <span class="n">password</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">),</span>
                        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">),</span>
                        <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf8mb4&#39;</span><span class="p">,</span>
                        <span class="n">cursorclass</span><span class="o">=</span><span class="n">pymysql</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read_sales</span><span class="p">():</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT date, currency, MIN(value) as value FROM ExchangeRates GROUP BY date, currency&quot;</span>
    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">df_exchange_rates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">df_exchange_rates</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_exchange_rates</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_exchange_rates</span>

<span class="k">def</span> <span class="nf">read_exchange_rates</span><span class="p">():</span>
    <span class="n">df_sample_sales</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;sample_sales.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">df_sample_sales</span><span class="o">.</span><span class="n">ORDERDATE</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_sample_sales</span><span class="o">.</span><span class="n">ORDERDATE</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_sample_sales</span>

<span class="k">def</span> <span class="nf">convert_sales</span><span class="p">(</span><span class="n">df_exchange_rates</span><span class="p">,</span> <span class="n">df_sample_sales</span><span class="p">):</span>
    <span class="n">df_output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">df_sample_sales</span><span class="p">,</span> 
        <span class="n">right</span> <span class="o">=</span> <span class="n">df_exchange_rates</span><span class="p">,</span> 
        <span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ORDERDATE&#39;</span><span class="p">,</span><span class="s1">&#39;CURRENCY&#39;</span><span class="p">],</span> 
        <span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;currency&#39;</span><span class="p">],</span> 
        <span class="n">how</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">df_output</span><span class="o">.</span><span class="n">SALES</span> <span class="o">=</span> <span class="n">df_output</span><span class="o">.</span><span class="n">SALES</span> <span class="o">/</span> <span class="n">df_output</span><span class="o">.</span><span class="n">value</span>
    <span class="n">df_output</span> <span class="o">=</span> <span class="n">df_output</span><span class="p">[[</span><span class="s1">&#39;ORDERDATE&#39;</span><span class="p">,</span><span class="s1">&#39;SALES&#39;</span><span class="p">,</span><span class="s1">&#39;PRODUCT&#39;</span><span class="p">,</span><span class="s1">&#39;CUSTOMERNAME&#39;</span><span class="p">,</span><span class="s1">&#39;COUNTRY&#39;</span><span class="p">]]</span>
    <span class="n">df_output</span><span class="p">[</span><span class="s1">&#39;CURRENCY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span>
    <span class="k">return</span> <span class="n">df_output</span>

<span class="k">def</span> <span class="nf">store_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;DELETE FROM Sales&#39;</span>
    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">query</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;(&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ORDERDATE&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;,</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SALES&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">,&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CURRENCY&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;,&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PRODUCT&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;,&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CUSTOMERNAME&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;,&quot;</span><span class="si">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;COUNTRY&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;),&#39;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;INSERT INTO Sales (orderdate, sales, currency, product, customer_name, country) VALUES </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">df_exchange_rates</span> <span class="o">=</span> <span class="n">read_sales</span><span class="p">()</span>
    <span class="n">df_sample_sales</span> <span class="o">=</span> <span class="n">read_exchange_rates</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">convert_sales</span><span class="p">(</span><span class="n">df_exchange_rates</span><span class="p">,</span> <span class="n">df_sample_sales</span><span class="p">)</span>
    <span class="n">store_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;processed data successful!&#39;</span><span class="p">)</span>
</code></pre></div>


<p>Great! Now we have a logic that takes our inputs, and converts it into a table which can be used for analysis purposes. </p>
<p>The process described above is an example of the <em>Transform</em> (Converting sales to USD values) and <em>Load</em> (Storing final Sales table) aspect of an <em>ETL</em> system. In the next post, we will have a look how we can make sure the process above is scheduled, so it is fully automated!</p></p>
                </div>
                <div class="col-md-4 sidebar">
                    <div class="sidebar-box">
                        <h3>ETL Part II - Transform and Load your data!</h3>
                        <img src="/static/img/blogposts/78.png" alt="Image" class="round-image img-fluid">
                        <p><p>Developing an <strong>ETL</strong> system, where we <strong>fetch</strong> data, transform and enrich, and prepare for <strong>visualisation</strong>!</p></p>
                    </div>
                    <div class="sidebar-box">
                        <div class="categories">
                            <h3>Latest posts</h3>
                            
                            <li><a href="/post/140/A-simple-dashboard-based-on-the-data-from-my-Arduino-project.html">A simple dashboard based on the data from my Arduino project</a></li>
                            
                            <li><a href="/post/139/Controling-Sonos-with-Python-in-just-a-couple-lines-of-code.html">Controling Sonos with Python in just a couple lines of code</a></li>
                            
                            <li><a href="/post/138/Tracking-temperature-in-you-house-using-Micro-controllers-and-Python.html">Tracking temperature in you house using Micro controllers and Python</a></li>
                            
                        </div>
                    </div>
                    <div class="sidebar-box">
                        <h3>Python Everything</h3>
                        <p>We at Python Everything try to provide you with your daily Python inspiration! Our post are ment to inspire you and ensure that you start coding in Python yourself.</p>
                        <p><a href="/about.html" class="btn btn-primary btn-sm">Read More</a></p>
                    </div>
                    <!--
                    <div class="sidebar-box">
                        <h3>Paragraph</h3>
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ducimus itaque, autem necessitatibus voluptate quod mollitia delectus aut, sunt placeat nam vero culpa sapiente consectetur similique, inventore eos fugit cupiditate numquam!</p>
                    </div>
                    -->
                </div>
            </div>
        </div>
    </section>

</main>



    <!-- ======= Footer ======= -->
    <footer class="footer" role="contentinfo">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4 mb-md-0">
                    <h3>About Python Everything</h3>
                    <p>We're python enthousiasts, who want to ensure you are getting the same smile on you face everytime your python script runs successfully.</p>
                </div>
                <div class="col-md-7 ml-auto">
                    <div class="row site-section pt-0">
                        <div class="col-md-4 mb-4 mb-md-0">
                            <h3>Navigation</h3>
                            <ul class="list-unstyled">
                                <li><a href="/">Home</a></li>
                                <li><a href="/explore/1.html">Expore</a></li>
                                <li><a href="/#contact">Get in touch</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row justify-content-center text-center">
                <div class="col-md-7">
                    <p class="copyright">&copy; Copyright Python Everything. All Rights Reserved</p>
                    <div class="credits">
                        Designed by <a href="/">Python Everything</a>
                    </div>
                </div>
            </div>

        </div>
    </footer>

    <a href="#" class="back-to-top"><i class="icofont-simple-up"></i></a>

    <!-- Vendor JS Files -->
    <script src="/static/vendor/jquery/jquery.min.js"></script>
    <script src="/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/static/vendor/jquery.easing/jquery.easing.min.js"></script>
    <script src="/static/vendor/aos/aos.js"></script>
    <script src="/static/vendor/owl.carousel/owl.carousel.min.js"></script>
    <script src="/static/vendor/jquery-sticky/jquery.sticky.js"></script>

    <!-- Template Main JS File -->
    <script src="/static/js/main.js"></script>

</body>

</html>